---
title: "Rapport Text Mining Earthworms"
output: html_document
date: "`r format(Sys.time(), '%d/%m/%y')`"
---

```{r setup,include=FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```


Premier bloc de code : importation des librairies.
```{r Libraries}
library(dplyr)
library(ggplot2)
library(tidytext)
library(tm)
library(knitr)
library(SemNetCleaner)
data("stop_words")
custom_stop_words <- tibble(word = c("plot","wild","slug","manipulation","apple"),  
                                      lexicon = c("custom"))
```
Deuxième bloc de code : définition des variables.
```{r Variables}

#----------------------------- 
earthworms <- read.csv("~/Documents/GitHub/EarthwormsMetanalysis/ExtractionBiblio/data_articles_metaanalyses.csv")
abstracts<-c()
#--------------------- 
names(earthworms)
n = nrow(earthworms)
```
Troisième bloc de code: ajout d'une colonne "aboutEarthworms".
```{r About Earthworms}
earthworms <- earthworms %>% mutate(aboutEarthworms = rep(TRUE,n))
```
Quatrième bloc de code: Construction de la liste des abstracts.
```{r Abstracts}
abstracts=earthworms$Abstract
```
Cinquième bloc de code : Construction d'un dataframe de tokens.
```{r Unnested tokens}
 # Unnest tokens for the current abstract
unnested_tokens <- tibble(abstracts) %>%
unnest_tokens(word, abstracts)
# Append the unnested tokens to the list
unnested_tokens<-unnested_tokens%>%anti_join(stop_words)
unnested_tokens<-unnested_tokens %>% rowwise() %>% mutate(word = singularize(word))
```
Analyse du dataframe: trouver les mots les plus communs dans les quatre MA confondues.

```{r Fréquence Totale mots}
ordre=unnested_tokens %>%
     count(word, sort = TRUE) %>%
     filter(n > 100) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))

 ordre$word = factor(ordre$word,levels=rev(levels(ordre$word)))
 ggplot(ordre,aes(n, word)) +
     geom_col() +
     labs(y = NULL)
```
<br> On peut voir que les trois mots les plus fréquents dans les articles des quatres métaanalyses confondues sont *earthworm*, *soil* et *plant*. On peut donc penser que les métaanalyses sont davantage portées sur le rôle écologique du ver de terre que sur l'étude des vers de terre à part entière.

<br>
<i>MA1: "Soil chemistry turned upside down: a meta-analysis of invasive  earthworm effects on soil chemical properties"<br>
MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis" <br>
MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American
forests (a meta-analysis)" <br>
MA4: "Earthworms increase plant production: a meta-analysis"</i>
<br>

# Création de subsets correspondant aux 4 MA individuellement, afin de pouvoir les comparer entre elles.

## Import subset MA1:
```{r Subset MA1}
splitedData <- split(earthworms,earthworms$MA)

abstracts1<-c()
MA1 <- splitedData$MA1
nMA1 <- nrow(MA1)
abstracts1<-MA1$Abstract
unnested_tokens1 <- tibble(abstracts1) %>%
unnest_tokens(word, abstracts1)
unnested_tokens1<-unnested_tokens1 %>% anti_join(stop_words)
unnested_tokens1<-unnested_tokens1 %>% rowwise() %>% mutate(word = singularize(word))
```
## Import subset MA2:
```{r Subset MA2}
abstracts2<-c()
MA2 <- splitedData$MA2
nMA2 <- nrow(MA2)
abstracts2<-MA2$Abstract
unnested_tokens2 <- tibble(abstracts2) %>%
unnest_tokens(word, abstracts2)
unnested_tokens2<-unnested_tokens2 %>% anti_join(stop_words)
unnested_tokens2<-unnested_tokens2 %>% rowwise() %>% mutate(word = singularize(word))
```
## Import subset MA3:
```{r Subset MA3}
abstracts3<-c()
MA3 <- splitedData$MA3
nMA3 <- nrow(MA3)
abstracts3<-MA3$Abstract
unnested_tokens3 <- tibble(abstracts3) %>%
unnest_tokens(word, abstracts3)
unnested_tokens3<-unnested_tokens3 %>% anti_join(stop_words)
unnested_tokens3<-unnested_tokens3 %>% rowwise() %>% mutate(word = singularize(word))
```
## Import subset MA4:
```{r Subset MA4}
abstracts4<-c()
MA4 <- splitedData$MA4
nMA4 <- nrow(MA4)
abstracts4<-MA4$Abstract
unnested_tokens4 <- tibble(abstracts4) %>%
unnest_tokens(word, abstracts4)
unnested_tokens4<-unnested_tokens4 %>% anti_join(stop_words)
unnested_tokens4<-unnested_tokens4 %>% rowwise() %>% mutate(word = singularize(word))
```
# Création des quatre plots:

## Plot MA1 :
```{r Construction plot 1}
ordre1=unnested_tokens1 %>%
     count(word, sort = TRUE) %>%
     filter(n > 25) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))

 ordre1$word = factor(ordre1$word,levels=rev(levels(ordre1$word)))
 plot1<-ggplot(ordre1,aes(n, word)) +
     geom_col() +
     labs(y = NULL)
```
## Plot MA2 :
```{r Construction plot 2}
ordre2=unnested_tokens2 %>%
     count(word, sort = TRUE) %>%
     filter(n > 25) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))

 ordre2$word = factor(ordre2$word,levels=rev(levels(ordre2$word)))
 plot2<-ggplot(ordre2,aes(n, word)) +
     geom_col() +
     labs(y = NULL)
```
## Plot MA3 :
```{r Construction plot 3}
ordre3=unnested_tokens3 %>%
     count(word, sort = TRUE) %>%
     filter(n > 25) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))

 ordre3$word = factor(ordre3$word,levels=rev(levels(ordre3$word)))
 plot3<-ggplot(ordre3,aes(n, word)) +
     geom_col() +
     labs(y = NULL)
```
## Plot MA4:
```{r Construction plot 4}
ordre4=unnested_tokens4 %>%
     count(word, sort = TRUE) %>%
     filter(n > 25) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))

 ordre4$word = factor(ordre4$word,levels=rev(levels(ordre4$word)))
 plot4<-ggplot(ordre4,aes(n, word)) +
     geom_col() +
     labs(y = NULL)
```
# Comparaison des quatre MA:

Quels sont les mots les plus communs dans chacunes des MA?

```{r ggarrange 4 plots,, fig.height=10,fig.width=10}
library(egg)
ggarrange(plot1,plot2,plot3,plot4,widths = c(5,5),labels = c("1","2","3","4"))
```
<br>On remarque que les mots les plus fréquents dans les articles des métaanalyses sont:
- *earthworm*, *soil* et *forest* pour la MA1 (qui semble donc s'intéresser plus particulièrement à l'écosystème forestier).
- *plant*, *earthworm* et *effect* pour la MA2 (qui semble donc vouloir étudier précisément les effets des vers de terre sur les plantes).
- *earthworm*, *specie*, et *plant* pour la MA3 (qui semble donc s'intéresser plus particulièrement à certaines espèces de vers de terre et leurs relations avec les plantes).
- *earthworm*, *plant* et *soil* pour la MA4 (qui semble donc étudier l'influence des vers de terre sur les sols et les plantes).
<br>
<i>MA1: "Soil chemistry turned upside down: a meta-analysis of invasive  earthworm effects on soil chemical properties"<br>
MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis" <br>
MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American
forests (a meta-analysis)" <br>
MA4: "Earthworms increase plant production: a meta-analysis"</i>
<br>
# DataFrame pour comparer les fréquences des 4 MA:

```{r Fréquence 1}
library(tidyr)

frequency1 <- bind_rows(mutate(unnested_tokens1, author = "MA1"),
                       mutate(unnested_tokens2, author = "MA2"), 
                       mutate(unnested_tokens3, author = "MA3"),
                       mutate(unnested_tokens4, author = "MA4"))%>% 
  mutate(word = stringr::str_extract(word, "[a-z']+")) %>%
  count(author, word) %>%
  group_by(author) %>%
  mutate(proportion = n / sum(n)) %>% 
  select(-n) %>% 
  pivot_wider(names_from = author, values_from = proportion) %>%
  pivot_longer(cols=c('MA2','MA3','MA4'),
               names_to = "author", values_to = "proportion")
```



```{r Fréquence 2}
frequency2 <- bind_rows(mutate(unnested_tokens1, author = "MA1"),
                       mutate(unnested_tokens2, author = "MA2"), 
                       mutate(unnested_tokens3, author = "MA3"),
                       mutate(unnested_tokens4, author = "MA4"))%>% 
  mutate(word = stringr::str_extract(word, "[a-z']+")) %>%
  count(author, word) %>%
  group_by(author) %>%
  mutate(proportion = n / sum(n)) %>% 
  select(-n) %>% 
  pivot_wider(names_from = author, values_from = proportion) %>%
  pivot_longer(cols=c('MA1','MA3','MA4'),
               names_to = "author", values_to = "proportion")

```


```{r Fréquence 3}
frequency3 <- bind_rows(mutate(unnested_tokens1, author = "MA1"),
                       mutate(unnested_tokens2, author = "MA2"), 
                       mutate(unnested_tokens3, author = "MA3"),
                       mutate(unnested_tokens4, author = "MA4"))%>% 
  mutate(word = stringr::str_extract(word, "[a-z']+")) %>%
  count(author, word) %>%
  group_by(author) %>%
  mutate(proportion = n / sum(n)) %>% 
  select(-n) %>% 
  pivot_wider(names_from = author, values_from = proportion) %>%
  pivot_longer(cols=c('MA1','MA2','MA4'),
               names_to = "author", values_to = "proportion")
```


# Graphe de comparaison des fréquences:
```{r Scale Plot, fig.width=15,fig.height=10}
library(scales)

# expect a warning about rows with missing values being removed
ggplot(frequency1, aes(x = proportion, y = `MA1`, 
                      color = abs(`MA1` - proportion))) +
  geom_abline(color = "gray40", lty = 2) +
  geom_jitter(alpha = 0.1, size = 2.5, width = 0.3, height = 0.3) +
  geom_text(aes(label = word), check_overlap = TRUE, vjust = 1.5) +
  scale_x_log10(labels = percent_format()) +
  scale_y_log10(labels = percent_format()) +
  scale_color_gradient(limits = c(0, 0.001), 
                       low = "darkslategray4", high = "gray75") +
  facet_wrap(~author, ncol = 2) +
  theme(legend.position="none") +
  labs(y = "MA1", x = NULL)
```

## MA1 vs MA2 : 
- Les mots proches de la ligne dans ces graphiques ont des fréquences similaires dans les deux ensembles de textes, soit, dans l'ordre croissant: 
"accelerated", "affecting","based", "dweling", "day", "change", "common", "availability", "negative", "abundance", "content", "increase", "activity", "concentration", **"litter", "biomass", "specie", "soil", "earthworm"**. On remarque que les mots les plus fréquents semblent être plus directement liés au sujet de l'article que les autres, qui paraissent plus générique au vocabulaire scientifique en écologie.

- Les mots **"invasion", "carbon", "layer" et "loss"** sont plus fréquents dans la MA1 que dans la MA2, tandis que les mots **"plant", "root", "shoot" et "grass"** sont plus fréquents dans la MA2 que de la MA1.

- Les mots **"specie", "effect", "soil" et "earthworm"** représentent entre 1 et 10% des mots totaux de chaque métaanalyse pour les métaanalyses 1 et 2 (échelle logarithmique).

## MA1 vs MA3 :
- Les mots proches de la ligne dans ces graphiques ont des fréquences similaires dans les deux ensembles de textes, soit, dans l'ordre croissant: 
"assessed", "basal", "abundant", "abiotic", "day", "biotic", "avalability", "compared", "america", "invasive", "european", "abundance", "study", "nutrient", "increased", "exotic", "ecosystem", "impact", "litter", "biomass", "effect", **"invasion", "forest", "specie", "soil", "earthworm"**. On remarque que certains mots dont la fréquence est proches pourraient peut-être faire partie du même groupe de mots (comme **"invasive european"**,**"nutrient increased"**, **"ecosystem impact"** ou encore **"litter biomass"**.)

- Les mots **"pool", "carbon", et "microbial** sont plus fréquents dans la MA1 que dans la MA3, tandis que les mots **"cover", "tree", "density" et "plant"** sont plus fréquents dans la MA3 que de la MA1.

- Les mots **"specie", "forest, "soil" et "earthworm"** représentent entre 1 et 10% des mots totaux de chaque métaanalyse pour les métaanalyses 1 et 3 (échelle logarithmique). On peut remarquer une forte ressemblance avec les résultats obtenus entre les MA 1 et 2.

## MA1 vs MA4 :
- Les mots proches de la ligne dans ces graphiques ont des fréquences similaires dans les deux ensembles de textes, soit, dans l'ordre croissant: 
"access","acquisition","data","australia", "amonium", "applied", "analysis", "due", "mass", "direct", "affect", "system", "native", "ecosystem", "density", "experiment", "organic", "activity", "litter", "community", "biomass", "specie", **effect, earthworm**. On remarque que certains mots dont la fréquence est proches pourraient peut-être faire partie du même groupe de mots (comme **acquisition data**, **direct effect**, **native ecosystem**, ou encore **litter community**).

- Les mots **"forest","invasion", "carbon" et "floor"** sont plus fréquents dans la MA1 que dans la MA4, tandis que les mots **"invader", "functional", "grassland", "grass" et "plant"** sont plus fréquents dans la MA4 que de la MA1.

- Les mots **"effect" et "earthworm"** représentent entre 1 et 10% des mots totaux de chaque métaanalyse pour les métaanalyses 1 et 4 (échelle logarithmique).

## Analyse globale:
- Dans cette configuration, la MA1 et la MA4 semblent être les plus similaires en termes de fréquences de mots (nuage de points davantage resserré autour de la droite.)

- Dans cette configuration, la MA1 et la MA2 semblent être les moins similaires en termes de fréquences de mots (nuage de points davantage dispersé autour de la droite.)

# Tests de corrélation:
Quel est le degré de corrélation entre les fréquences de mots de chaque métaanalyse ?

## MA2 VS MA1
```{r Corr 2 vs 1}
cor.test(data = frequency1[frequency1$author == "MA2",],
         ~ proportion + `MA1`)
```

## MA3 VS MA1
```{r Corr 3 vs 1}
cor.test(data = frequency1[frequency1$author == "MA3",],
         ~ proportion + `MA1`)
```

## MA4 VS MA1
```{r Corr 4 vs 1}
cor.test(data = frequency1[frequency1$author == "MA4",],
         ~ proportion + `MA1`)
```

## MA3 VS MA2
```{r Corr 3 vs 2}
cor.test(data = frequency2[frequency2$author == "MA3",],
         ~ proportion + `MA2`)
```

## MA4 VS MA2
```{r Corr 4 vs 2}
cor.test(data = frequency2[frequency2$author == "MA4",],
         ~ proportion + `MA2`)
```

## MA4 VS MA3
```{r Corr 4 vs 3}
cor.test(data = frequency3[frequency3$author == "MA4",],
         ~ proportion + `MA3`)
```
## Tableau récapitulatif :

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:14px;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-0pky{border-color:inherit;text-align:left;vertical-align:top}
</style>
<table class="tg">
<thead>
  <tr>
    <th class="tg-0pky"></th>
    <th class="tg-0pky"><span style="font-weight:bold">MA1</span></th>
    <th class="tg-0pky"><span style="font-weight:bold">MA2</span></th>
    <th class="tg-0pky"><span style="font-weight:bold">MA3</span></th>
    <th class="tg-0pky"><span style="font-weight:bold">MA4</span></th>
  </tr>
</thead>
<tbody>
  <tr>
    <td class="tg-0pky"><span style="font-weight:bold">MA1</span></td>
    <td class="tg-0pky">   -</td>
    <td class="tg-0pky">0.671</td>
    <td class="tg-0pky">0.799</td>
    <td class="tg-0pky">0.779</td>
  </tr>
  <tr>
    <td class="tg-0pky"><span style="font-weight:bold">MA2</span></td>
    <td class="tg-0pky"></td>
    <td class="tg-0pky">    -</td>
    <td class="tg-0pky">0.793</td>
    <td class="tg-0pky">0.825</td>
  </tr>
  <tr>
    <td class="tg-0pky"><span style="font-weight:bold">MA3</span></td>
    <td class="tg-0pky"></td>
    <td class="tg-0pky"></td>
    <td class="tg-0pky">    -</td>
    <td class="tg-0pky">0.740</td>
  </tr>
  <tr>
    <td class="tg-0pky"><span style="font-weight:bold">MA4</span></td>
    <td class="tg-0pky"></td>
    <td class="tg-0pky"></td>
    <td class="tg-0pky"></td>
    <td class="tg-0pky">    -</td>
  </tr>
</tbody>
</table>

<br>
<i>MA1: "Soil chemistry turned upside down: a meta-analysis of invasive  earthworm effects on soil chemical properties"<br>
MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis" <br>
MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American
forests (a meta-analysis)" <br>
MA4: "Earthworms increase plant production: a meta-analysis"</i>
<br>

D'après le tableau ci-dessus, on peut voir que le choix de mots est le plus corrélé (correlation de Pearson) entre la MA2 et la MA4 (r²=0.825), tandis que le choix de mots est le moins corrélé (corrélation de Pearson) entre la MA1 et la MA2 (r²=0.671).

# Analyse de sentiments entre les 4 métaanalyses:

## Premiers graphiques.

On commence par construire des Tibbles contenant chaque mot exprimant un sentiment positif ou négatif (colonne *word*), puis on compte le nombre d'occurence de chaque mot (colonne *n*).

```{r Construction Tibbles Senti, message=FALSE}
library(tidytext)
bing<-get_sentiments("bing")

senti1<-unnested_tokens1 %>%
  inner_join(bing) %>%
  count(word, sort = TRUE)

senti2<-unnested_tokens2 %>%
  inner_join(bing) %>%
  count(word, sort = TRUE)

senti3<-unnested_tokens3 %>%
  inner_join(bing) %>%
  count(word, sort = TRUE)

senti4<-unnested_tokens4 %>%
  inner_join(bing) %>%
  count(word, sort = TRUE)
```

On ne conserve que les dix premières valeurs et les dix dernières valeurs, afin de pouvoir produire des graphiques plus lisibles ne conservant que les valeurs extrêmes.

```{r Filtrage des valeurs, message=FALSE}
library(tidyr)
MA1_senti <- senti1 %>%
  inner_join(get_sentiments("bing")) %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  pivot_wider(names_from = sentiment, values_from = n, values_fill = 0) %>% 
  mutate(sentiment = positive - negative)
sub1_MA1_senti<-MA1_senti %>%
    arrange(sentiment) %>%
    slice(1:10)
sub2_MA1_senti<-MA1_senti %>%
    arrange(desc(sentiment)) %>%
    slice(1:10)
sub_MA1_senti<-bind_rows(sub1_MA1_senti, sub2_MA1_senti)
```

On réalise un premier barplot de sentiment à titre d'exemple, en associant à chaque mot positif l'indice +1, et à chaque mot négatif l'indice -1. On représente ensuite cela graphiquement chaque mot en abscisse et la somme de ses indices (dont la valeur dépend de sa connotation et du nombre d'occurences) en ordonnées. On peut noter que certains mots neutres dans un contexte scientifique (comme "plot" ou "manipulation") ont été rajoutés au dictionaire de "stop words", pour éviter qu'ils soient considérés à tort comme des mots à valence négative.


```{r Plot senti exemple}
ggplot(sub_MA1_senti, aes(x = word, y = sentiment, fill = factor(sign(sentiment)))) +
  geom_bar(stat = "identity") +
  labs(x = "Word", y = "Sentiment Score", fill = "Sentiment") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

On répète le processus pour comparer les métaanalyses 1,2,3 et 4.

```{r Création plot senti, message=FALSE}
library(tidyr)
library(ggplot2)

plot_sentiment_subset <- function(senti) {
  MA_senti <- senti %>%
    inner_join(get_sentiments("bing")) %>%
    pivot_wider(names_from = sentiment, values_from = n, values_fill = 0) %>% 
    mutate(sentiment = positive - negative)
  
  sub1_MA_senti <- MA_senti %>%
    anti_join(custom_stop_words, by = c("word")) %>%
    arrange(sentiment) %>%
    slice(1:5)
  
  sub2_MA_senti <- MA_senti %>%
    anti_join(custom_stop_words, by = c("word")) %>%
    arrange(desc(sentiment)) %>%
    slice(1:5)
  
  sub_MA_senti <- bind_rows(sub1_MA_senti, sub2_MA_senti)
  
  ggplot(sub_MA_senti, aes(x = word, y = sentiment, fill = factor(sign(sentiment)))) +
    geom_bar(stat = "identity") +
    labs(x = "Word", y = "Sentiment Score", fill = "Sentiment") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

plot_senti1<-plot_sentiment_subset(senti1)
plot_senti2<-plot_sentiment_subset(senti2)
plot_senti3<-plot_sentiment_subset(senti3)
plot_senti4<-plot_sentiment_subset(senti4)

```

```{r ggarrange plot senti}
library(egg)
ggarrange(plot_senti1,plot_senti2,plot_senti3,plot_senti4,widths = c(2,2),labels = c("1","2","3","4"))
```

Tout d'abord, il est immportant de noter que tous les graphes n'ont pas les mêmes échelles ; les MA1 et 4 semblent avoir des échelles de sentiment comparables ([-20;10] et [-10;20]) et cela vaut aussi pour les MA2 et 3 ([-10;5] et [-5;10])

On peut constater que le mot positif *"significant"* est retrouvé dans tous les corpus fournis, tandis que *"abundance"* est retrouvé dans la plupart de métaanalyses (1,2 et 3). Il serait cependant nécessaire d'inspecter des unités textuelles plus larges pour interpréter au mieux ce résultat, car la signification de ces mots peut grandement dépendre des autres mots auquels ils sont associés et du contexte. 
le mot *"dynamic* n'est retrouvé que dans les MA1 et 3. A l'inverse, Le mot *"unaffected"* n'est quant à lui retrouvé que dans les MA2 et 4. On peut émettre l'hypothèse que les MA2 et 4 se focalisent sur les mécanismes de préservation et de résistance, alors que la 1 et la 3 sont davantage axées sur la dynamique des écosystèmes.

On peut constater qu'il n'y a aucun mot négatif commun à tous les corpus. Cependant, les mots *"invasive"* ou *"invader"* sont retrouvées dans las MA 1, 3 et 4, ce qui sous-entend que la MA2 s'intéresse moins aux espèces invasives que les trois autres.
On peut aussi remarquer que le mot *"loss"* n'est retrouvé que dans les MA1 et 4, ce qui semble indiquer que les effets négatifs relevés ne sont pas forcément liés à des pertes de caractéristiques. Le mot *"severity"*, à l'inverse, n'est retrouvé que dans les MA3 et 4, ce qui signifie peut-être qu'elles sont plus "quantitatives" que les deux autres. 
On peut enfin constater que le mot *"loss"* est le mot avec le score négatif le plus important des quatre graphiques, représenté dans la MA1. 

<br>
<i>MA1: "Soil chemistry turned upside down: a meta-analysis of invasive earthworm effects on soil chemical properties"<br>
MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis" <br>
MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American
forests (a meta-analysis)" <br>
MA4: "Earthworms increase plant production: a meta-analysis"</i>
<br>

## Contribution de chaque terme au score final de sentiment.
```{r Contribution sentiment, message=FALSE}
bing_word_counts1 <- unnested_tokens1 %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  mutate(MA="MA1") %>%
  ungroup() 
bing_word_counts2 <- unnested_tokens2 %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  mutate(MA="MA2") %>%
  ungroup()
bing_word_counts3 <- unnested_tokens3 %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  mutate(MA="MA3") %>%
  ungroup() 
bing_word_counts4 <- unnested_tokens4 %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  mutate(MA="MA4") %>%
  ungroup()
```

```{r Plot contrib}
contrib1<-bing_word_counts1 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  group_by(sentiment) %>%
  slice_max(n, n = 10) %>% 
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(x = "Contribution to sentiment",
       y = NULL)

contrib2<-bing_word_counts2 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  group_by(sentiment) %>%
  slice_max(n, n = 10) %>% 
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(x = "Contribution to sentiment",
       y = NULL)

contrib3<-bing_word_counts3 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  group_by(sentiment) %>%
  slice_max(n, n = 10) %>% 
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(x = "Contribution to sentiment",
       y = NULL)

contrib4<-bing_word_counts4 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  group_by(sentiment) %>%
  slice_max(n, n = 10) %>% 
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(x = "Contribution to sentiment",
       y = NULL)
```

```{r ggarrange contrib, fig.height=10,fig.width=10}
library(egg)
ggarrange(contrib1,contrib2,contrib3,contrib4,widths = c(2,2),labels = c("1","2","3","4"))
```

Tout d'abord, il faut noter que les graphiques ne sont pas à la même échelle en abscisse. Cela ne pose en théorie pas de problème pour interpréter les résultats au cas par cas, mais cela rentrera en jeux lors d'éventuelles comparaisons entre métaanalyses.

<u>Les quatre mots positifs les plus importants en contribution sont: </u><br> 
* *MA1:* "abundance", dynamic", "dominated","significant".<br>
* *MA2:* "enhanced", "abundance", "variety","significant".<br>
* *MA3:* "richness", "abundance", "significant","leading".<br>
* *MA4:* "significant", "unnaffected", "enhanced","enhance".<br>
On remarque tout d'abord que le mot *"significant"* fait partie des quatre mots qui a le plus contribué au sentiment dans tous les subsets. Le contexte semble nécessaire pour savoir s'il est employé pour décrire un phénomène positif ou négatif.<br>
Par ailleurs, le mot *"abundance"* est dans les premiers pour les MA 1, 2 et 3, mais pas pour la MA4, ce qui pourrait signifier qu'elle est moins orientée sur la richesse écosystémique que les autres. De plus, la présence des mots *"enhanced"* et *"enhance"* semble montrer que, comme son nom l'indique, elle choisit une approche plus quantitative (étude de la **production**) que les autres.<br>

<u>Les quatre mots négatifs les plus importants en contribution (en ne comptant pas "rocky", qui dans ce contexte est sans doute employé au sens propre de "rocheux/rocailleux", comme par exemple dans le groupe de mots "Rocky area".) sont: </u><br> 
* *MA1:* "loss", "invasive", "negative", "poorly".<br>
* *MA2:* "drought", "negative", "dead","absence".<br>
* *MA3:* "invasive", "burned", "severity","negative".<br>
* *MA4:* "invader", "severity", "infested","absence".<br>
On remarque d'abord qu'aucun des mots négatifs relevés n'est présent dans les quatre premiers de toutes les métaanalyses. Cela dit, le mot *"negative"* semble être le mieux réparti, car présent dans 3 MA sur les 4 (1,2 et 3). De la même façon, on peut aussi noter que les mots *"invasive"* et *"invader"* sont aussi présents dans les 4 premiers de 3 MA sur les 4 (1,3 et 4, respectivement en 2e et 1er position pour *"invasive"* et 1er position pour *"invader"*).<br>
On peut aussi noter que *"invasive"* semble souvent dans le même groupe que *"negative* (MA1,3), tandis que le mot *"invader"*, lui, semble plutôt associé avec *"infested"* (MA4).<br>
La MA2 semble sortir du lot, avec des mots uniques comme *"drought"* et *"dead"*. Cela pourrait indiquer que l'étude s'intéresse davantage aux effets des vers de terre sur la physiologie végétale en tant que telle plutôt qu'à leurs aoports écologiques ou de production, ce qui semble en accord avec le titre donné à cette métaanalyse.<br>

Da façon simpliste, il semble donc possible, à partir de ces graphiques, de proposer une première catégorisation comme suit:<br>
- **MA1/MA3:** étude de l'impact écologique des vers de terre sur les écosystèmes.<br>
- **MA2:** étude des effets des vers de terre sur la physiologie végétale.<br>
- **MA4:** étude de l'influence des vers de terre invasifs sur la production végétale. 

Cependant, il serait peut-être nécessaire d'étudier des unités textuelles plus larges, comme par exemple les phrases, pour éviter au maximum le risque de contresens.

<br>
<i>MA1: "Soil chemistry turned upside down: a meta-analysis of invasive earthworm effects on soil chemical properties"<br>
MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis" <br>
MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American
forests (a meta-analysis)" <br>
MA4: "Earthworms increase plant production: a meta-analysis"</i>
<br>

# Représentation visuelle de la fréquence des mots: Wordclouds

## Wordcloud MA1: "Soil chemistry turned upside down: a meta-analysis of invasive earthworm effects on soil chemical properties"

Visuellement, on peut voir sur le nuage de mots que les termes prépondérants dans la MA1 sont : *"earthworm","soil","forest"* et *"effect"*. On peut remarquer aussi que le mot *"invasion"* semble aussi relativement fréquent, ce qui est cohérent avec le titre de l'article ("invasive earthworms"). La prépondérance du mot *"earthworm"* sur les autres semble confirmer que les vers de terre sont le sujet principal de cette métaanalyse.

```{r Wordcloud 1}
library(wordcloud)
library(dplyr)

unnested_tokens1 %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 50))
cloud1 <- recordPlot()
```

## Wordcloud MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis"

Visuellement, on peut voir sur le nuage de mots que les termes prépondérants dans la MA2 sont : *"plant","earthworm","aphid", "soil"* et *"effect"*. D'autres mots tel que *"increased", "community", "interaction", "presence" ou "biomass"* semblent décrire un processus biologique dynamique. La prépondérance de *"plant"* sur les autres semble confirmer que la biologie végétale en lien avec les vers de terre est le thème principal de cette métaanalyse.

```{r Wordcloud 2}
unnested_tokens2 %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 50))
cloud2 <- recordPlot()
```

## Wordcloud MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American forests (a meta-analysis)"

Visuellement, on peut voir sur le nuage de mots que les termes prépondérants dans la MA3 sont : *"earthworm","specie", "plant"* et *"forest"*. La prépondérance des mots *"earthworm"* et *"specie"* sur les autres semble confirmer que la métaanlyse s'intéresse en particulier à la façon dont les différentes **espèces** de vers de terre (natives ou introduite) influent sur l'écosystème global (et notamment l'écosystème **forestier**). D'autres mots tel que *"invasion", "community", "interaction", "presence"* ou *"biomass"* semblent décrire un processus écologique dynamique.

```{r Wordcloud 3}
unnested_tokens3 %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 50))
cloud3 <- recordPlot()
```

## Wordcloud MA4: "Earthworms increase plant production: a meta-analysis"

Visuellement, on peut voir sur le nuage de mots que les termes prépondérants dans la MA4 sont : *"earthworm","soil", "plant"* et *"increased"*. La prépondérance de ces mots semble confirmer que cette métaanalyse montre un effet positif ("increased" et "production") des vers de terre sur les plantes, via, probablement, une amélioration de la qualité des sols (voir des mots comme "decomposer", "nurient", "growth", "organic", qui sont souvent utilisés pour décrire les sols favorables à la croissance végétale).

```{r Wordcloud 4}
unnested_tokens4 %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 50))
cloud4 <- recordPlot()
```

# Wordcloud: coloration en fonction de la valence des mots (bleu: Positif / rouge: Négatif)
## Wordcloud MA1: "Soil chemistry turned upside down: a meta-analysis of invasive earthworm effects on soil chemical properties"

Visuellement, on peut voir sur le nuage de mots que les termes positfs prépondérants dans la MA1 sont *"abundance", "dynamic"* et *dominated*, tandis que les termes négatifs prépondérants sont *"loss","invasive"* et *"negative"*. On remarque tout d'abord que ces résultats sont très différents de ceux trouvés dans la partie précédente pour la même métaanalyse (Wordclouds: Wordcloud MA1) à cause de l'ajout de la variable "sentiment". On peut aussi constater grâce à la taille de chaque mot du nuage et à la quantité de mots négatifs et positifs que la métaanalyse 1 semble porter un avis plutôt négatif sur son sujet d'étude (ici, l'impact des vers de terre sur les écosystèmes).


```{r Wordcloud senti1, warning=FALSE}
library(reshape2)

unnested_tokens1 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("red", "blue"),
                   max.words = 100)
cloud_senti1<-recordPlot()
```

## Wordcloud MA2: "Earthworms affect plant growth and resistance against herbivores: A meta-analysis" 

Visuellement, on peut voir sur le nuage de mots que les termes positfs prépondérants dans la MA2 sont *"enhanced", "abundance"* et *variety*, tandis que les termes négatifs prépondérants sont *"drought","negative"* et *"dead"*. On remarque tout d'abord que ces résultats sont très différents de ceux trouvés dans la partie précédente pour la même métaanalyse (Wordclouds: Wordcloud MA2) à cause de l'ajout de la variable "sentiment". On peut aussi constater grâce à la taille de chaque mot du nuage et à la quantité de mots négatifs et positifs que la métaanalyse 2 semble porter un jugement moins tranché que la précédente sur son sujet d'étude, sans dominance claire des mots positifs ou des mots négatifs (même si le mot le plus représenté, "drought", est un mot à valence négative).

```{r Wordcloud senti2, warning=FALSE}
unnested_tokens2 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("red", "blue"),
                   max.words = 100)
cloud_senti2<-recordPlot()
```

## Wordcloud MA3: "The unseen invaders: introduced earthworms as drivers of change in plant communities in North American forests (a meta-analysis)"

Visuellement, on peut voir sur le nuage de mots que les termes positfs prépondérants dans la MA3 sont *"richness", "abundance"* et *significant*, tandis que les termes négatifs prépondérants sont *"invasive","burned"* et *"negative"*. On remarque tout d'abord que ces résultats sont très différents de ceux trouvés dans la partie précédente pour la même métaanalyse (Wordclouds: Wordcloud MA3) à cause de l'ajout de la variable "sentiment". On peut aussi constater grâce à la taille de chaque mot du nuage et à la quantité de mots négatifs et positifs que la métaanalyse 3 semble aussi porter jugement nuancé sur son sujet d'étude, sans dominance claire des mots positifs ou des mots négatifs (même si le mot le plus représenté, "richness", est un mot à valence positive). On peut cependant constater par la présence du mot "invasive" **et** du mot "invader" dans le même nuage que cette métaanalyse semble davantage parler d'invasion biologique que les autres.

```{r Wordcloud senti3, warning=FALSE}
unnested_tokens3 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("red", "blue"),
                   max.words = 100)
cloud_senti3<-recordPlot()
```

## Wordcloud MA4: "Earthworms increase plant production: a meta-analysis"

Visuellement, on peut voir sur le nuage de mots que les termes positfs prépondérants dans la MA4 sont *"significant", "unaffected" et "enhance"*, tandis que les termes négatifs prépondérants sont *"invader","severity"* et *"infested"*. On remarque tout d'abord que ces résultats sont très différents de ceux trouvés dans la partie précédente pour la même métaanalyse (Wordclouds: Wordcloud MA4) à cause de l'ajout de la variable "sentiment". On peut cependant constater par la présence des mots "infested", "severity", "absence" et "invader" que la métaanalyse semble porter un jugement plutôt négatif, ce qui semble étonnant au vu du titre de la métaanalyse. Par ailleurs, même si le mot central, **"significant"**, est théoriquement le plus fréquent, on pourrait penser que la métaanalyse contient plus de mots positifs que de mots négatifs. Cependant, nous avons déjà vu que dans un contexte scientifique, la valence de ce mot dépend beaucoup du groue de mots auquel il est associé.

```{r Wordcloud senti4, warning=FALSE}
unnested_tokens4 %>%
  anti_join(custom_stop_words, by = c("word")) %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("red", "blue"),
                   max.words = 100)
cloud_senti4<-recordPlot()
```
```{r Sentence tokens}
sentences1 <- tibble(text = abstracts1) %>% 
  unnest_tokens(sentence, text, token = "sentences")
sentences2 <- tibble(text = abstracts2) %>% 
  unnest_tokens(sentence, text, token = "sentences")
sentences3 <- tibble(text = abstracts3) %>% 
  unnest_tokens(sentence, text, token = "sentences")
sentences4 <- tibble(text = abstracts4) %>% 
  unnest_tokens(sentence, text, token = "sentences")
```

## Ratios de mots positifs / négatifs pour chaque métaanalyse:  
```{r Ratio}
library(dplyr)
library(purrr)
library(kableExtra)

bingnegative <- get_sentiments("bing") %>% 
  filter(sentiment == "negative")

unnested_tokens1 <- unnested_tokens1 %>%
  mutate(MA = "MA1")
unnested_tokens2 <- unnested_tokens2 %>%
  mutate(MA = "MA2")
unnested_tokens3 <- unnested_tokens3 %>%
  mutate(MA = "MA3")
unnested_tokens4 <- unnested_tokens4 %>%
  mutate(MA = "MA4")

MA_labels <- c("MA1", "MA2", "MA3", "MA4")
word_counts_MA <- c(length(unnested_tokens1$word), length(unnested_tokens2$word), length(unnested_tokens3$word), length(unnested_tokens4$word))

word_count_tibble <- tibble(
  MA = MA_labels,
  words = word_counts_MA
)

all_ratios <- bind_rows(unnested_tokens1,unnested_tokens2,unnested_tokens3,unnested_tokens4)

joined_tibble <- inner_join(all_ratios, bingnegative, by = "word")

MA_titles <- c("Soil chemistry turned upside down: a meta-analysis [...]","Earthworms affect plant growth and resistance [...]","The unseen invaders: [...] in north American forests (a meta-analysis)","Earthworms increase plant production: a meta-analysis") 

summary_tibble <- joined_tibble %>%
  group_by(MA) %>%
  summarize(
    negativewords = n()
  ) %>%
  left_join(word_count_tibble, by = "MA") %>%
  mutate(ratio = negativewords / words) %>%
  ungroup() %>%
  mutate(MA_title = MA_titles) %>%
  mutate(current_MA = MA) %>%
  select(MA_title, current_MA, words, negativewords, ratio)

 summary_tibble %>%
  kbl() %>%
  kable_material_dark("hover", full_width = F) %>%
  row_spec(0, bold = T, color = "black", background = "#D7261E")
```
<br>
Ci-dessus un classement des métaanalyses contenant le plus de mots négatifs (MA1>MA2>MA3>MA4), normalisés en fonction du nombre de mots dans chaque métaanalyse (colonne "ratio"). On peut remarquer que les métaanalyses sont exactement en ordre décroissant (la MA1 est la plus négative, la MA4 la moins négative), ce qui est une coïncidence plutôt surprenante. On peut donc écrire, de manière synthétique, que:<br>
* **MA1:** 3,3% des mots totaux sont des mots négatifs.<br>
* **MA2:** 2,9% des mots totaux sont des mots négatifs.<br>
* **MA3:** 2,6% des mots totaux sont des mots négatifs.<br>
* **MA4:** 2% des mots totaux sont des mots négatifs.<br>
Ces ratios permettent notamment d'expliquer par des proportions précises la différence observée plus tôt entre les nuages de mots bruts et les nuages de mots prenant en compte la valence (score de sentiment) des mots, les deux groupes étudiés étant de taille et de composition tès différente.

# Approche tf-idf :
<br>
**Définitions:**
<br>
*tf*: term frequency.<br>
*idf*: inverse document frequency. Plus élaboré que l'approche en "stop words". Diminue la fréquence des termes rencontrés très souvent et augmente la fréquence des termes rares, en jouant sur la pondération.<br>
*tf-idf*: le produit de ces deux indices. Il premet de mesurer l'importance **de 1 mot dans 1 document** d'un corpus de documents.<br>

```{r Redéfinition des formats tidy sans filtration des "stop_words"}
unnested_tokens1 <- tibble(abstracts1) %>%
mutate(MA="MA1") %>%
unnest_tokens(word, abstracts1)
unnested_tokens1<-unnested_tokens1 %>% rowwise() %>% mutate(word = singularize(word))

unnested_tokens2 <- tibble(abstracts2) %>%
  mutate(MA="MA2") %>%
  unnest_tokens(word, abstracts2)
unnested_tokens2 <- unnested_tokens2 %>% rowwise() %>% mutate(word = singularize(word))

unnested_tokens3 <- tibble(abstracts3) %>%
  mutate(MA="MA3") %>%
  unnest_tokens(word, abstracts3)
unnested_tokens3 <- unnested_tokens3 %>% rowwise() %>% mutate(word = singularize(word))

unnested_tokens4 <- tibble(abstracts4) %>%
  mutate(MA="MA4") %>%
  unnest_tokens(word, abstracts4)
unnested_tokens4 <- unnested_tokens4 %>% rowwise() %>% mutate(word = singularize(word))
```

```{r Mots totaux MA}
word_counts_MA <- c(length(unnested_tokens1$word), length(unnested_tokens2$word), length(unnested_tokens3$word),length(unnested_tokens4$word))

ordre1=unnested_tokens1 %>%
     count(word, sort = TRUE) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))
tokens_ordered_1 <- left_join(unnested_tokens1, ordre1) %>%
  mutate(Total=word_count_tibble$words[1])

ordre2=unnested_tokens2 %>%
     count(word, sort = TRUE) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))
tokens_ordered_2 <- left_join(unnested_tokens2, ordre2) %>%
  mutate(Total=word_count_tibble$words[2])

ordre3=unnested_tokens4 %>%
     count(word, sort = TRUE) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))
tokens_ordered_3 <- inner_join(unnested_tokens3, ordre3) %>%
  mutate(Total=word_count_tibble$words[3])

ordre4=unnested_tokens4 %>%
     count(word, sort = TRUE) %>%
     mutate(word = reorder(word, n,decreasing=TRUE))
tokens_ordered_4 <- left_join(unnested_tokens4, ordre4) %>%
  mutate(Total=word_count_tibble$words[4])

all_freq <- bind_rows(tokens_ordered_1,tokens_ordered_2,tokens_ordered_3,tokens_ordered_4) %>% mutate(word_frequency = n/Total)
```

```{r tf-plots, warning=FALSE}
library(ggplot2)
library(egg)
 
word_freq_plot1 <- ggplot(all_freq, aes(x = word_frequency, fill = MA)) +
  geom_histogram(bins=100,show.legend = FALSE) +
  ggtitle("xlim = max_word_frequency") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlim(NA, max(all_freq$word_frequency)) +
  facet_wrap(~MA, ncol = 2, scales = "free_y")

word_freq_plot2 <-ggplot(all_freq, aes(x = word_frequency, fill = MA)) +
  geom_histogram(bins=100,show.legend = FALSE) +
  ggtitle("xlim = 0.05") + 
  theme(plot.title = element_text(hjust = 0.5)) +
  xlim(NA, 0.05) +
  facet_wrap(~MA, ncol = 2, scales = "free_y")

ggarrange(word_freq_plot1,word_freq_plot2,widths = c(1,2))

```

Ces graphiques présentent des distributions proches pour toutes les MA, avec de nombreux mots qui apparaissent rarement et moins de mots qui apparaissent fréquemment (le premier groupe de 4 graphes représentant l'intégralité des données, le deuxième groupe de 4 se focalisant uniquement sur l'intervalle [0;0.05], pour inspecter le massif de pics davantage en détail). En x, on peut voir que les mots apparaissant très souvent (à droite) sont rares, alors que les mots qui apparaissent peu souvent (à gauche) sont fréquents. Ces graphiques présentent des distributions similaires pour toutes les MA, avec de nombreux mots qui apparaissent rarement et moins de mots qui apparaissent fréquemment. 

## Loi de Zipf:
```{r}
freq_and_rank <-  all_freq %>%
    group_by(MA, word) %>%
    summarize(n = sum(n), Total = first(Total)) %>% # isoler une seule fois la valeur de "Total" pour chaque MA (on retient la première occurence). La valeur du Total pour chaque MA est constante.
    ungroup() %>%
    group_by(MA) %>%
    arrange(desc(n)) %>%
    mutate(rank = row_number()) %>%
    ungroup()
```



